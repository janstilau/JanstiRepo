# 重构

在不改变代码的外在行为的前提下, 对于代码做出修改, 改进程序的内部结构. 重构是在代码写好之后改进它的设计.

之前的设计, 在经过需求的变化之后, 整体结构逐渐减弱, 代码质量慢慢沉沦. 重构则是, 将它加工成设计良好的代码. 重构有很多简单的做法, 例如代码抽取成为函数, 子类公共行为抽取到基类, 这些小的动作加在一起, 可以改变代码质量. 而且, 最为重要的是, 重构的过程, 是在设计的过程, 设计不再是一开始就想好的, 而是整个开发过程中一点点的浮现出来的.

## 第一个示例

一个租用影片的实例

影片有分类, 分类不同价钱不同
根据租的时间不同, 最后总价不同
顾客有积分, 根据积分不同, 最后的价钱也不同.

最初的程序, 所有的计算都在一个 statement 的函数里面, 里面取出顾客所有的租用记录, 租用记录里面有租用时间和影片实例, 然后在循环里面根据影片类型做加法.

所有的东西都在一起, 导致任何修改都非常困难. 如果要增加 html 的输出, 如果要增加影片分类, 如果要改变价格的计算公式, 都要直接修改 statement 函数, 或者复制拷贝, 在大量重复的代码里面做一些小修改来完成一个新的功能.

* 如果, 你发现自己需要为程序增加一个特性, 而代码的结构无法使你很方便的达成自己的目的, 那就先重构程序, 使得特性的添加容易进行, 然后在添加特性.

### 编写测试数据

好的测试是重构的基础, 测试需要能够自我追踪, 报告出现问题的位置和错误原因, 避免花费大量的时间去寻找错误.

### 分解

statement 的处理逻辑实在太长了

* 代码块越是小, 代码的功能也就越容易管理, 代码的处理和移动也就越轻松.

* 重构的本质, 每次的修改幅度都很小, 所以任何的错误都很容易发现. 不用花费大量的时间做调试.

* 任何人都可以写出计算机可以理解的代码, 唯有写出人类可以容易理解的代码, 才是优秀的程序员.

代码应该可以自我表现, 这样的代码要求有很好的变量命名和函数命名, 类命名.

### 位置错误

* 绝大多数的情况下, 代码应该放在它所使用的数据的所属对象里面. 所以, amountFor(抽取出来的计算每个租用价格的函数) 应该放到 Rental 类里面.

这里, Customer 类里面, 有一个 amountFor(rental), Rental 里面也有一个, 如果 Customer 里面的 amountFor 是一个 public, 并且被多个地方用到了, 那么可以保持接口不变, 只不过修改 amountFor 中的代码为 rental.amountFor() 就可以了. 作者没有上来就删去 Customer 的 amountFor, 而是先进行了测试, 在测试通过了之后, 在进行函数调用的替换. 为了就是, 每次修改都很小, 保证很容易的可以发现问题.

### replace temp with query

statement 里面有个循环, 取出所有的 rental 对象, 然后累加最后的价格和用户积分的增量. 然后作者方法将这个遍历操作封装了. totalPrice, totalScore. 在这两个方法里面, 又对 rentals 进行遍历, 然后取出最后的总和. 也就是说, 原来的一次遍历, 现在成为了三次. 但是, 在增加 htmlStatement 的时候, 这两个方法被复用了. 不然, htmlStatement 的代码结构, 会有很多的和 statement 的相同.

这样增加遍历次数的问题, 其实是增加了性能负担. 但是程序的复用性增加了. 并且增加了两个 toal 的接口, 在之后的扩展的时候, 都方便了.

### 多态 代替 switch

* 不要在另外的一个种类对象的属性上, 增加 switch 函数, 如果要添加, 就在自己的属性上添加.

其实很简单, 如果对另外一个种类对象的属性做 switch 操作, 那么其实, 这个方法应该是那个种类对象的方法.

这里还是一个代码责任的问题, switch 这种结构, 太容易增加新的分类. 这就要对原来的代码进行修改, 一般来说, 出现 switch 的地方, 都是我们自定义的 enum 的地方, 而那个定义 enum 的地方, 应该是从属于那个类的. 增加了一个新的 enum, 他所在的那个类的功能发生了变化, 进行修改没有问题. 但是使用它的类不应该进行修改, 应为类型增加和使用者没有关系.

为了将 switch 变成多态, 其实是增加了很多很多的类, 并且代码的结构实际上是变得复杂的多了. 但是这样的结果是, 后面的修改和增加, 都会变得很容易. 外界并不知道到底发生了什么变化, 它们只是增加功能和更改需求, 但是变得容易了.

### 结果

重构后的程序风格, 变成了结构化的, 这和之前, 所有的代码写到 statement 的过程化有了很大的区别, 这样的代码将代码的责任分的清楚, 也易于扩展.
重构的时候, 测试, 小修改, 测试, 小修改, 这是重构可以快速安全的进行的基础.