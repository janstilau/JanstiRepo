现有 At 功能实现逻辑
现有的 At 功能, 是通过在 @用户名称 周围, 增加特殊的标签来实现的.

例如:  

"今天我家里没人 @我就看看内脏 @岁月流年 一起来打电动"   为移动端显示给用户的信息, 其中 "@我就看看内脏 @岁月流年" 应该添加高亮显示和点击效果.  这段文字在数据库中实际存储为

"今天我家里没人 <McAtTaCH clz="mem_refer" uid="3409536231">@我就看看内脏 </McAtTaCH><McAtTaCH clz="mem_refer" uid="1056659188">@岁月流年 </McAtTaCH>一起来打电动"

其中 McAtTaCH 为萌股项目现在使用的特殊字符, 用该字符来判断某一处文字应该被当做标签块来进行解析.

在标签的属性中, 固定有着 clz 属性, 作为分辨标签类型的依据.

除了 clz 文本外, 其他的属性 key 值是随着类型变化的. 目前, At 功能的类型标识为 mem_refer, 仅仅有一个属性 uid.

除了标签的属性信息外, <McAtTaCH key="value">这是标签文本内容</McAtTaCH>, "这是标签文本内容", 也是重要的信息, 用来表示该标签块应如何用文本进行展示.

例如, 各个聊天软件中的表情, 显示给用户的是丰富的表情图片, 但是在输入框中, 经常表示为 "[炸弹], [鼓掌]".  "[炸弹], [鼓掌]" 就是表情的文本表示, 可以在合适的场景中使用.

为何用标签的形式来实现功能?
在调研了微博, 知乎, 腾讯新闻的 At 功能后, 发现知乎是通过标签的方式来实现的. 权衡过后, 发现标签的形式有着如下的好处.

通过标签传递信息的方式是业内常用手段.
帖子大部分的数据, 还是文本. 目前的需求为在纯文本之中, 插入一些特殊显示的内容. 这个时候, 显示的内容, 和内容所在的位置是同等重要的.
如果通过接口中另外的字段来实现功能, 是需要传递位置信息的. 例如, images 中除了图片的信息, 还要有一个 location 信息, 用来表示该图片应该在哪个字符后进行显示.
这种显示逻辑既难以理解, 又完全不能应对变化, 如果要修改帖子内容还要兼顾图片位置的修改, 容错率太差.
而标签的方式, 使得所有的内容保持在一份完整的文本中. 特殊显示的内容, 完全包裹在普通的文本之中.
帖子内容更改时, 只要保持一个标签单元的完整性不被破坏, 其他的文本内容可以随意删除添加.
HTML 作为一种标记语言, 将所有要显示的内容, 用纯文本的方式进行存储传递, 在显示时客户端再解析为不同类型的内容.  萌股用标签来实现功能, 其实也是借鉴了 HTML 的设计思路.
通过标签的方式, 可以很方便的扩展新功能.
McAtTaCH 作为一个特殊的标签, 目的在于不与业内常用标签进行混淆. 在识别了萌股专属标签块之后, 再通过 clz 属性的值进行类别识别. 
如果, 想要实现一个新的功能, 那么帖子数据仅仅是增加一个新的标签类型而已.
在新版本的客户端程序中, 可以解析新的类型, 进行特殊的视图展示. 老版本的客户端, 不能识别该类型, 则直接展示该类型的文本内容.
为了兼容新版本内容, 客户端应该做好兼容工作. 在现在的版本中, 只能识别 At 功能的标签, 那么在遇到图片类型的标签时, 应该显示[图片].
在客户端做好类别兼容后, 以后添加新的类别时, 就不用考虑版本兼容问题了.
通过标签的方式, 服务器端工作量增加不大
由于所有的信息, 都存储在文本中, 所以数据库的结构不用重新设计. 
客户端应该做好解析的工作. 在需要解析为视图显示时, 将标签数据还原为各种UI 视图, 例如图片, 标签, At 用户. 在不需要解析为视图显示时, 应该去除标签数据, 用纯文本方式来显示, 例如在帖子列表中,  "今天我家里没人 <McAtTaCH clz="mem_refer" uid="3409536231">@我就看看内脏 </McAtTaCH>" 应该显示 为 "今天我家里没人@我就看看内脏 ".  
服务器端在个别地方需要做内容的重新组织, 在推送通知时, 由于推送的内容, 无法经过客户端的解析程序, 所以应该先去除标签, 然后将文本推送到手机端. At 功能需要给被 At 的用户发送消息, 这个时候也要进行属性信息的抽取.
万事有利有弊, 该方案也有着以下的弊端:

帖子内容会被标签占据, 如果增加太多标签, 用户可输入的文字会减少
用文本的方式传递数据, 会占用用户可以输入的文字长度.
在设计类别的时候, 应考虑到属性名, 属性值, 属性个数应尽可能的节俭.
但某些场合无论如何节省, 也无法控制标签的长度. 例如, 图片的 url 本身就是一个很长的数据.
太多的标签, 很有可能会导致帖子内容超过数据库的长度显示, 导致发帖失败. 目前数据库中帖子长度2500, 在新版本图文贴的产品案子中, 帖子长度为 10000 字.
功能复杂度增加, 对于客户端开发人员要求增加
标签的匹配, 需要熟悉相关的正则规则. 在匹配之后, 需要对内容进行抽取, 根据 clz 的值, 各个属性的内容, 构建对应的视图显示.
要编写完善的, 可兼容的, 容易扩展的处理逻辑, 需要编写人员进行思考, 设计.
同时, 在不同的时机, 要进行不同的展示; 在和服务器端交互时, 要发送带有标签的原始数据; 在实现复制剪贴等常见的文本编辑功能时, 要复制标签数据, 粘贴之后进行视图显示.
各种细节的处理, 都需要编码人员的耐性和设计能力.

客户端应如何解析标签数据?
以 "今天我家里没人 <McAtTaCH clz="mem_refer" uid="3409536231">@我就看看内脏 </McAtTaCH><McAtTaCH clz="mem_refer" uid="1056659188">@岁月流年 </McAtTaCH>一起来打电动" 为例.

当客户端读取到该文本后:

使用正则表达式判断, 该文本中是否含有萌股标签. 如果没有, 则按照纯文本格式进行展示.
对萌股标签里的内容进行抽取, 获取标签属性的各个信息, 获取标签的文本表示信息.
根据 clz 的值, 生成不同的视图进行展示. 如果当前版本不能处理该类型, 则展示标签的文本信息.
根据以上获得的信息, 生成对应的帖子视图.
目前判断萌股标签的正则表达式为:  "(<McAtTaCH .*?>)(.*?)(</McAtTaCH>)",  根据正则表达式的 group capture 的概念, 以上表达式可以获取到 0: 整个标签块, 1: 含有属性信息的标签, 2: 标签的文本表示, 3: </McAtTaCH>.

在获取到含有属性信息的标签, 用该正则获取属性信息: "([a-zA-Z-_]+)=\"([\w+&@#\/%?=~\-_|!:,.;]+)",  根据正则表达式的 group capture 的概念, 以上表达式可以获取到: 0:整个属性相等表达式, 1: key 值, 2: value 值.

客户端应如何发送标签数据?
以 "今天我家里没人 @我就看看内脏 @岁月流年 一起来打电动" 为例.

客户端在发送网络请求是, 应该将 @我就看看内脏 转化成为 <McAtTaCH clz="mem_refer" uid="3409536231">@我就看看内脏 </McAtTaCH>. 

对于属性的书写格式规定为, key 值前后不加引号, 后面是等号, value 值前后加引号, 引号前是等号.

应该将 @岁月流年 转化成为 <McAtTaCH clz="mem_refer" uid="1056659188">@岁月流年 </McAtTaCH>. 

如果还有其他类型的视图, 也应该将视图转化为标签化的文本, 插入到帖子相应的位置.

目前萌股使用了哪些标签类型?
萌股目前只有 At 功能通过标签进行实现.

At: clz 值为 mem_refer, 固定有 uid 属性, 表示用户的 moegoCode

图片: clz 值为 img, 固定有 url 属性, 表示图片的 URL, w 属性, 表示图片宽度, h 属性, 表示图片的高度.   

今天我家里没人 <McAtTaCH clz="img" w="700" h="1244" url="http://t.images.moego.net/picture/post/1063494775/-s8G8J4hy5sArFhtmvoyIaEMAbmRHgmf.jpg">[图片]</McAtTaCH><McAtTaCH clz="img" w="700" h="1244" url="http://t.images.moego.net/picture/post/1063494775/-s8G8J4hy5sArFhtmvoyIaEMAbmRHgmf.jpg">[图片] </McAtTaCH>一起来打电动

未来可以通过标签实现的功能.

表情: clz 值为 stick, 固定有 id 属性, 表示表情的唯一标识.

表情, 实际上就是图片, 所以也应该有 url, width, height 信息.
由于表情是由萌股自己进行管理的, 所以可以通过另外的途径获取表情的详细信息. 例如一个专门的接口, 返回所有的表情的数据, 包括 id, url, type, width, height.
在客户端应该将表情信息进行存储, 实际展示时根据 id 值获取到各个属性后构建相应视图.
而在标签中只保留 id 属性, 这样可以大大降低表情对于文本的占用.
